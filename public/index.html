<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>juicebox file host</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0f141b; --panel:#1a2230; --accent:#ff9800; --accent-rgb:255 152 0; --text:#e8ecf3; --danger:#e53935; --ok:#4caf50; --radius:14px; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; }
    * { box-sizing:border-box; }
    body { margin:0; background:#0f141b; color:var(--text); min-height:100dvh; display:flex; flex-direction:column; }
    header { padding:1.9rem 1.2rem 1rem; text-align:center; }
    h1 { margin:0 0 .45rem; font-size:clamp(2rem,4.2vw,3.25rem); color:var(--text); letter-spacing:.5px; font-weight:600; }
    p.lead { margin:0; opacity:.72; font-size:.95rem; }

    main { width:min(880px,82%); margin:1.1rem auto 2.5rem; display:grid; gap:1.6rem; grid-template-columns:1fr; }
    .panel { position:relative; background:#1a2230; border:1px solid #273242; border-radius:var(--radius); overflow:hidden; box-shadow:0 4px 16px -8px rgba(0,0,0,.6); }
    .panel section { padding:1.25rem 1.35rem 1.5rem; }
    .panel h2 { margin:0 0 1rem; font-size:1.05rem; font-weight:600; letter-spacing:.7px; text-transform:uppercase; opacity:.85; }

    .drop-zone { position:relative; border:2px dashed #3a4658; border-radius:calc(var(--radius) - 4px); padding:3.5rem 1rem; text-align:center; cursor:pointer; background:#1d2735; min-height:240px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:.65rem; transition:.25s border-color,.25s background,.25s transform; width:100%; overflow:hidden; }
    /* striped warning overlay */
    .drop-zone::before { content:""; position:absolute; inset:0; background:repeating-linear-gradient(135deg,#24303d 0 18px,#24303d 18px 36px, #ffb300 36px 48px, #ffb300 48px 60px); opacity:.08; pointer-events:none; mix-blend-mode:overlay; }
    .drop-zone.drag { border-color:var(--accent); background:#223044; transform:scale(1.01); }
    .drop-zone.drag::before { opacity:.18; }
    .drop-zone input { display:none; }
    .drop-zone .icon { font-size:3.2rem; filter:drop-shadow(0 4px 8px rgba(0,0,0,.5)); margin-bottom:.35rem; }
    .muted { opacity:.62; font-size:.72rem; letter-spacing:.4px; }

    ul#fileList { list-style:none; margin:.9rem 0 0; padding:0; display:flex; flex-direction:column; gap:.65rem; max-height:320px; overflow:auto; scrollbar-width:thin; }
    ul#fileList li { background:#222e3d; border:1px solid #2c394a; padding:.7rem .8rem .6rem; border-radius:11px; font-size:.78rem; display:flex; flex-direction:column; gap:.65rem; position:relative; }
    ul#fileList li.error { border-color:var(--danger); }
    ul#fileList li.done { border-color:var(--ok); }

    .file-row { display:grid; grid-template-columns:minmax(0,1fr) auto auto; align-items:center; gap:.6rem; }
    .file-row .actions { display:flex; align-items:center; justify-content:center; }
    .file-row .name { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:500; }
    .file-row .size { font-variant-numeric:tabular-nums; opacity:.7; font-size:.65rem; }
    .file-row .actions { display:flex; gap:.35rem; }
    .file-row button.remove { background:#2d3a49; border:1px solid #364556; color:#b9c4ce; font-size:.55rem; padding:.25rem .4rem; border-radius:5px; cursor:pointer; }
    .file-row button.remove:hover { background:#344454; }
    .bar { height:5px; background:#141e28; border-radius:5px; overflow:hidden; margin-top:4px; box-shadow:inset 0 0 0 1px #1d2732; transition:height .45s ease, background-color .45s ease, margin-top .45s ease; }
    .bar span { display:block; height:100%; width:0%; background:var(--accent); transition:width .28s ease, opacity .25s ease; }
    .bar span.complete { background:var(--ok); }
    .bar.divider { height:2px; background:#2c394a; box-shadow:none; margin-top:6px; }
    .bar.divider span { opacity:0; }
    button.icon-trash { background:#3a2426; border:1px solid #452c2e; color:#e8b7b6; width:26px; height:26px; padding:0; border-radius:6px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.18s background,.18s border-color,.18s color; }
    button.icon-trash:hover { background:#4e2f32; border-color:#5a373a; color:#ffc7c5; }
    button.icon-trash:active { background:#402527; }
    button.icon-trash:disabled { opacity:.45; cursor:default; }
    button.icon-trash svg { width:14px; height:14px; pointer-events:none; }

    .links { display:flex; flex-direction:column; gap:.35rem; margin-top:.3rem; }

    .link-input { width:100%; background:#121b24; border:1px solid #2b394a; color:var(--text); font-size:.63rem; padding:.4rem .5rem; border-radius:6px; font-family:monospace; letter-spacing:.4px; cursor:pointer; }
    .link-input:focus { outline:1px solid var(--accent); border-color:var(--accent); }

    footer { margin:auto 0 0; padding:1.25rem; text-align:center; font-size:.63rem; opacity:.42; letter-spacing:.7px; }

    .site-note { margin-top:1rem; font-size:.64rem; color:#97a4b4; letter-spacing:.5px; line-height:1.35; opacity:.75; }
    .site-note a { color:#c4ccd6; text-decoration:underline; }
    .site-note a:hover { color:var(--accent); }

    #snackbar { position:fixed; bottom:26px; left:50%; transform:translateX(-50%) translateY(20px); background:#222e3d; color:var(--text); padding:.65rem 1rem; font-size:.7rem; border:1px solid #2d3948; border-radius:8px; opacity:0; pointer-events:none; transition:.35s; letter-spacing:.5px; box-shadow:0 6px 18px -8px rgba(0,0,0,.55); }
    #snackbar.show { opacity:1; transform:translateX(-50%) translateY(0); }

    #ownedList { list-style:none; margin:0; padding:0; }
    #ownedList .owned-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:.75rem; }
    .owned-chip { background:#222e3d; border:1px solid #2c394a; padding:.6rem .65rem .55rem; border-radius:10px; font-size:.62rem; display:flex; flex-direction:column; gap:.45rem; position:relative; }
    .owned-chip .top { display:flex; align-items:center; gap:.4rem; }
    .owned-chip .name { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:500; }
    .owned-chip .actions { display:flex; gap:.3rem; }
    .owned-chip button.small { background:#2d3a49; border:1px solid #364556; color:#c4ced7; font-size:.55rem; padding:.28rem .5rem; border-radius:5px; cursor:pointer; letter-spacing:.4px; }
    .owned-chip button.small:hover { background:#344454; }
    .owned-chip button.small:disabled { opacity:.45; cursor:default; }
    .owned-chip .link-input.mini { font-size:.55rem; padding:.3rem .45rem; }
    #ownedPanel h2 { display:flex; align-items:center; justify-content:space-between; }
    #ownedPanel h2 span.count { font-weight:400; opacity:.55; font-size:.65rem; letter-spacing:.5px; }
    @media (max-width:680px){ .owned-chip { padding:.55rem .55rem .5rem; } }
    @media (max-width:680px){ .drop-zone { padding:1.25rem .75rem; } ul#fileList { max-height:240px; } }
  </style>
</head>
<body>
  <header>
    <h1>juicebox</h1>
    <p class="lead">Flat, fast uploads. Drag & drop. Links appear when ready.</p>
  </header>
  <main>
    <div class="panel"><section>
      <h2>Upload</h2>
      <div class="ttl-row" style="display:flex;align-items:center;gap:.55rem;margin:.3rem 0 1rem;font-size:.62rem;letter-spacing:.4px;">
        <label for="ttlSelect" style="opacity:.8;">Retention:</label>
        <select id="ttlSelect" style="background:#121b24;border:1px solid #2b394a;color:var(--text);padding:.3rem .45rem;border-radius:6px;font-size:.62rem;">
          <option value="1h">1h</option>
          <option value="3h">3h</option>
          <option value="12h">12h</option>
          <option value="1d">1d</option>
          <option value="3d" selected>3d</option>
          <option value="7d">7d</option>
          <option value="14d">14d</option>
        </select>
        <div style="opacity:.55;">(auto delete after)</div>
      </div>
      <label class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" multiple />
        <div class="icon">üìÅ</div>
        <div class="muted">Click or drop files</div>
      </label>
      <ul id="fileList"></ul>
      <p class="site-note">Upload your files. Links show after each finishes. Files expire after selected retention (default 3d). See <a href="/faq" target="_blank" rel="noopener">FAQ</a>.</p>
    </section></div>
    <div class="panel" id="ownedPanel" style="display:none"><section>
      <h2>Your Files</h2>
      <ul id="ownedList"></ul>
      <p class="site-note" style="margin-top:.6rem">These are files linked to your IP (server-detected). They persist across refresh until deleted.</p>
    </section></div>
  </main>
  <footer>juicebox // simple high-speed file host</footer>
  <div id="snackbar">Copied</div>
  <script>
    // Rewritten client logic for stable uploads & deletes
    const dropZone = document.getElementById('dropZone');
    // ensure input exists
    if(!document.getElementById('fileInput')) {
      const inp = document.createElement('input'); inp.type='file'; inp.multiple=true; inp.id='fileInput'; inp.style.display='none'; dropZone.appendChild(inp);
    }
    const fileInput = document.getElementById('fileInput');
    const list = document.getElementById('fileList');
    const snackbar = document.getElementById('snackbar');
    const ownedList = document.getElementById('ownedList');
    const ownedPanel = document.getElementById('ownedPanel');
    const ttlSelect = document.getElementById('ttlSelect');
    let ownedMeta = new Map(); // name -> expires (unix seconds)
    if(ttlSelect){
      const saved = localStorage.getItem('ttlChoice');
      if(saved && [...ttlSelect.options].some(o=>o.value===saved)) ttlSelect.value = saved;
      ttlSelect.addEventListener('change', ()=> localStorage.setItem('ttlChoice', ttlSelect.value));
    }

    function flashCopied(msg='Link copied'){ snackbar.textContent = msg; snackbar.classList.add('show'); clearTimeout(flashCopied._t); flashCopied._t=setTimeout(()=>snackbar.classList.remove('show'),1600); }
    async function copyToClipboard(text){ try{ await navigator.clipboard.writeText(text);}catch{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch{} document.body.removeChild(ta);} }
    function fmtBytes(b){ if(!isFinite(b) || b<0) return '‚Äì'; if(b===0) return '0 B'; const k=1024; const s=['B','KB','MB','GB','TB']; const i=Math.min(s.length-1, Math.floor(Math.log(b)/Math.log(k))); return (b/Math.pow(k,i)).toFixed(i?2:0)+' '+s[i]; }

    let batches=[]; // [{files:[] , linksBox?}]
    let uploading=false;
    let ownedCache=new Set();

    function makeLinkInput(rel, autoCopy=true){ const full=location.origin+'/'+rel; const inp=document.createElement('input'); inp.type='text'; inp.readOnly=true; inp.value=full; inp.className='link-input'; if(autoCopy){ copyToClipboard(full).then(()=>flashCopied()); } inp.addEventListener('click',()=>{ inp.select(); copyToClipboard(inp.value).then(()=>flashCopied()); }); return inp; }
    const _origMakeLinkInput = makeLinkInput; makeLinkInput = function(rel, autoCopy){ const el=_origMakeLinkInput(rel, autoCopy); if(rel.startsWith('f/')) addOwned(rel.slice(2)); return el; };
    // helper: map ttl code -> seconds
    function ttlCodeSeconds(code){ return ({'1h':3600,'3h':10800,'12h':43200,'1d':86400,'3d':259200,'7d':604800,'14d':1209600})[code] || 259200; }

    function addBatch(fileList){ if(!fileList || !fileList.length) return; const batch={ files:[...fileList].map(f=>({ file:f, remoteName:null, done:false, deleting:false, bar:null, barSpan:null, container:null, linksBox:null, xhr:null })) }; batches.push(batch); renderList(); autoUpload(); }

    function renderList(){
      // incremental: only create DOM for file objects lacking container
      batches.forEach(batch=>{
        const multi = batch.files.length>1;
        if(multi && !batch.linksBox){ batch.linksBox=document.createElement('div'); batch.linksBox.className='links'; }
        batch.files.forEach((f, idx)=>{
          if(f.container) return; // already rendered
          const li=document.createElement('li'); f.container=li;
          const row=document.createElement('div'); row.className='file-row';
          const name=document.createElement('div'); name.className='name'; name.textContent=f.file?f.file.name:(f.remoteName||'file');
          const size=document.createElement('div'); size.className='size'; size.textContent=f.file?fmtBytes(f.file.size):'';
          const actions=document.createElement('div'); actions.className='actions';
          const del=document.createElement('button'); del.type='button'; del.className='remove'; del.textContent='x'; del.title='Remove';
          del.addEventListener('click', (e)=>{ e.stopPropagation(); handleDeleteClick(f, batch); });
          f.deleteBtn = del;
          actions.appendChild(del);
          row.appendChild(name); row.appendChild(size); row.appendChild(actions); li.appendChild(row);
          const bar=document.createElement('div'); bar.className='bar'; bar.innerHTML='<span></span>'; const span=bar.querySelector('span'); span.style.transition='none'; f.bar=bar; f.barSpan=span; li.appendChild(bar);
          if(!multi){ /* single upload gets links after completion */ }
          list.appendChild(li);
          if(multi && batch.linksBox && !batch.linksBox.isConnected){ li.appendChild(batch.linksBox); }
        });
      });
    }

    function updateDeleteButton(f){ if(!f.deleteBtn) return; if(f.deleting){ f.deleteBtn.disabled=true; f.deleteBtn.textContent='‚Ä¶'; return; } if(!f.remoteName){ f.deleteBtn.textContent='x'; f.deleteBtn.disabled=false; f.deleteBtn.title='Remove (not uploaded)'; } else { f.deleteBtn.textContent='del'; f.deleteBtn.disabled=false; f.deleteBtn.title='Delete from server'; } }

    function handleDeleteClick(f, batch){
      if(f.deleting) return;
      if(!f.remoteName){ // local removal pre-upload
        if(f.xhr){ try{ f.xhr.abort(); }catch{} }
        if(f.container) f.container.remove();
        batch.files = batch.files.filter(x=>x!==f);
        if(!batch.files.length){ batches = batches.filter(b=>b!==batch); }
        return;
      }
      deleteRemote(f, batch);
    }

    function deleteRemote(f, batch){ if(!f.remoteName || f.deleting) return; f.deleting=true; updateDeleteButton(f);
      fetch('/d/'+encodeURIComponent(f.remoteName), {method:'DELETE'})
        .then(r=>{ if(r.ok){ if(f.container) f.container.remove(); batch.files = batch.files.filter(x=>x!==f); if(!batch.files.length) batches = batches.filter(b=>b!==batch); ownedCache.delete(f.remoteName); renderOwned([...ownedCache]); if(ownedPanel) ownedPanel.style.display = ownedCache.size?'':'none'; }
          else { f.deleting=false; updateDeleteButton(f); }
        })
        .catch(()=>{ f.deleting=false; updateDeleteButton(f); });
    }

    async function uploadSequential(){ if(uploading) return; uploading=true; for(const batch of batches){ for(const f of batch.files){ if(f.done || f.deleting) continue; await uploadOne(f, batch); } } uploading=false; }

    function uploadOne(f, batch){ return new Promise(resolve=>{
      const fd=new FormData();
      const ttlSel=document.getElementById('ttlSelect');
      const ttlVal = ttlSel? ttlSel.value : '3d';
      fd.append('ttl', ttlVal);
      fd.append('file', f.file, f.file.name);
      const xhr=new XMLHttpRequest(); f.xhr=xhr; xhr.open('POST','/upload'); xhr.responseType='json';
      xhr.upload.onprogress=(e)=>{ if(e.lengthComputable && f.barSpan){ const pct=(e.loaded / f.file.size)*100; f.barSpan.style.width=pct.toFixed(2)+'%'; } };
      xhr.onload=()=>{ const ok = xhr.status>=200 && xhr.status<300; if(ok){
          // ensure bar finishes even if no progress events fired
          if(f.barSpan){ if(!f.barSpan._animated){ f.barSpan._animated=true; f.barSpan.style.transition='width .35s ease, background-color .45s ease'; }
            f.barSpan.style.width='100%';
            requestAnimationFrame(()=>{
              f.barSpan.classList.add('complete');
              setTimeout(()=>{ if(f.bar && f.barSpan.classList.contains('complete')) f.bar.classList.add('divider'); },2000);
            });
          }
          let rel=null; try { const data=xhr.response || JSON.parse(xhr.responseText||'{}'); rel = data.files && data.files[0]; } catch{}
          if(rel){ f.remoteName = rel.startsWith('f/')? rel.slice(2): rel; }
          // store provisional expiry immediately so UI doesn't show expired
          const exp = Math.floor(Date.now()/1000) + ttlCodeSeconds(ttlVal);
          ownedMeta.set(f.remoteName, exp);
          f.done=true; updateDeleteButton(f);
          if(f.remoteName){ const input = makeLinkInput('f/'+f.remoteName, !batch.files.some(x=>!x.done)); if(batch.files.length>1){ if(batch.linksBox) batch.linksBox.appendChild(input); } else { const links=document.createElement('div'); links.className='links'; links.appendChild(input); f.container.appendChild(links); } }
          resolve();
        } else { f.container?.classList.add('error'); updateDeleteButton(f); resolve(); }
      };
      xhr.onerror=()=>{ f.container?.classList.add('error'); updateDeleteButton(f); resolve(); };
      xhr.send(fd);
      updateDeleteButton(f);
    }); }

    function autoUpload(){ uploadSequential(); }

    async function loadExisting(){ try { const r=await fetch('/mine'); if(!r.ok) return; const data=await r.json(); if(data && Array.isArray(data.files)){ data.files.forEach(f=> addOwned(f.replace(/^f\//,''))); if(Array.isArray(data.metas)){ data.metas.forEach(m=>{ const name=m.file.replace(/^f\//,''); ownedMeta.set(name, m.expires); }); } } } catch {} }
    function renderOwned(names){ if(!ownedList) return; ownedList.innerHTML=''; if(!names.length){ ownedPanel.style.display='none'; return; } ownedPanel.style.display=''; const grid=document.createElement('div'); grid.className='owned-grid'; names.sort(); const nowSec=Date.now()/1000; names.forEach(n=>{ const hasMeta=ownedMeta.has(n); const exp=hasMeta? ownedMeta.get(n): -1; const remain=exp-nowSec; const chip=document.createElement('div'); chip.className='owned-chip'; if(exp>=0) { chip.dataset.exp=exp; } chip.dataset.name=n; function fmtRemain(sec){ if(exp<0) return '...'; if(sec<=0) return 'expired'; const units=[['d',86400],['h',3600],['m',60],['s',1]]; let rem=sec; let out=[]; for(const [u,v] of units){ if(out.length>=2) break; if(rem>=v){ const val=Math.floor(rem/v); out.push(val+u); rem%=v; } } return out.length?out.join(' '):'secs'; }
        chip.innerHTML=`<div class="top"><div class="name" title="${n}">${n}</div><div class="actions"></div></div><div class="ttl" style="font-size:.5rem;opacity:.55;letter-spacing:.4px;">${fmtRemain(remain)}</div>`; const actions=chip.querySelector('.actions'); const copyBtn=document.createElement('button'); copyBtn.className='small'; copyBtn.textContent='copy'; copyBtn.addEventListener('click',()=>{ copyToClipboard(location.origin+'/f/'+n).then(()=>flashCopied()); }); actions.appendChild(copyBtn); const delBtn=document.createElement('button'); delBtn.className='small'; delBtn.textContent='del'; delBtn.addEventListener('click',()=>{ const fObj = batches.flatMap(b=>b.files).find(f=>f.remoteName===n); if(fObj) deleteRemote(fObj, batches.find(b=>b.files.includes(fObj))); else { fetch('/d/'+encodeURIComponent(n), {method:'DELETE'}).then(r=>{ if(r.ok){ ownedCache.delete(n); ownedMeta.delete(n); renderOwned([...ownedCache]); if(!ownedCache.size) ownedPanel.style.display='none'; } }); } }); actions.appendChild(delBtn); const mini=document.createElement('input'); mini.type='text'; mini.readOnly=true; mini.className='link-input mini'; mini.value=location.origin+'/f/'+n; mini.addEventListener('click',()=>{ mini.select(); copyToClipboard(mini.value).then(()=>flashCopied()); }); chip.appendChild(mini); grid.appendChild(chip); }); ownedList.appendChild(grid); }
    async function refreshOwned(){ try { const r=await fetch('/mine',{cache:'no-store'}); if(!r.ok) return; const data=await r.json(); if(data && Array.isArray(data.files)){ const set=new Set(data.files.map(f=>f.replace(/^f\//,''))); ownedCache=set; if(Array.isArray(data.metas)){ ownedMeta.clear(); data.metas.forEach(m=> ownedMeta.set(m.file.replace(/^f\//,''), m.expires)); } renderOwned([...ownedCache]); } } catch{} }
    function addOwned(remoteName){ if(!remoteName) return; if(!ownedCache.has(remoteName)){ ownedCache.add(remoteName); renderOwned([...ownedCache]); } }
    // countdown updater
    setInterval(()=>{ const now=Date.now()/1000; document.querySelectorAll('.owned-chip').forEach(chip=>{ const expAttr=chip.dataset.exp; if(!expAttr){ return; } const exp=parseFloat(expAttr||'0'); const ttlEl=chip.querySelector('.ttl'); if(!ttlEl) return; const remain=Math.floor(exp-now); if(remain<=0){ ttlEl.textContent='expired'; return; } function fmt(sec){ const units=[['d',86400],['h',3600],['m',60],['s',1]]; let rem=sec; let out=[]; for(const [u,v] of units){ if(out.length>=2) break; if(rem>=v){ const val=Math.floor(rem/v); out.push(val+u); rem%=v; } } return out.length?out.join(' '):'secs'; } ttlEl.textContent=fmt(remain); }); }, 1000);

    function setupUploadEvents(){ if(window._uploadEventsBound) return; window._uploadEventsBound=true; if(!dropZone||!fileInput) return; fileInput.addEventListener('change',()=>{ if(fileInput.files.length) addBatch(fileInput.files); fileInput.value=''; }); ['dragenter','dragover'].forEach(ev=> dropZone.addEventListener(ev,e=>{ e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag'); })); ['dragleave','dragend'].forEach(ev=> dropZone.addEventListener(ev,e=>{ e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag'); })); dropZone.addEventListener('drop',e=>{ e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag'); if(e.dataTransfer && e.dataTransfer.files.length) addBatch(e.dataTransfer.files); }); dropZone.addEventListener('click',()=> fileInput.click()); }

    setupUploadEvents();
    loadExisting();
    document.addEventListener('paste', e=>{ if(e.clipboardData && e.clipboardData.files.length) addBatch(e.clipboardData.files); });
    refreshOwned(); setInterval(refreshOwned,15000); window.addEventListener('focus', refreshOwned);
  </script>
</body>
</html>
